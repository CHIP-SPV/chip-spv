\hypertarget{hip__test__common_8hh_source}{}\doxysection{hip\+\_\+test\+\_\+common.\+hh}
\label{hip__test__common_8hh_source}\index{/Users/pvelesko/local/CHIP-\/SPV/HIP/tests/catch/include/hip\_test\_common.hh@{/Users/pvelesko/local/CHIP-\/SPV/HIP/tests/catch/include/hip\_test\_common.hh}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{/*}}
\DoxyCodeLine{2 \textcolor{comment}{Copyright (c) 2021 -\/ 2021 Advanced Micro Devices, Inc. All rights reserved.}}
\DoxyCodeLine{3 \textcolor{comment}{}}
\DoxyCodeLine{4 \textcolor{comment}{Permission is hereby granted, free of charge, to any person obtaining a copy}}
\DoxyCodeLine{5 \textcolor{comment}{of this software and associated documentation files (the "{}Software"{}), to deal}}
\DoxyCodeLine{6 \textcolor{comment}{in the Software without restriction, including without limitation the rights}}
\DoxyCodeLine{7 \textcolor{comment}{to use, copy, modify, merge, publish, distribute, sublicense, and/or sell}}
\DoxyCodeLine{8 \textcolor{comment}{copies of the Software, and to permit persons to whom the Software is}}
\DoxyCodeLine{9 \textcolor{comment}{furnished to do so, subject to the following conditions:}}
\DoxyCodeLine{10 \textcolor{comment}{}}
\DoxyCodeLine{11 \textcolor{comment}{The above copyright notice and this permission notice shall be included in}}
\DoxyCodeLine{12 \textcolor{comment}{all copies or substantial portions of the Software.}}
\DoxyCodeLine{13 \textcolor{comment}{}}
\DoxyCodeLine{14 \textcolor{comment}{THE SOFTWARE IS PROVIDED "{}AS IS"{}, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR}}
\DoxyCodeLine{15 \textcolor{comment}{IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,}}
\DoxyCodeLine{16 \textcolor{comment}{FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE}}
\DoxyCodeLine{17 \textcolor{comment}{AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER}}
\DoxyCodeLine{18 \textcolor{comment}{LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,}}
\DoxyCodeLine{19 \textcolor{comment}{OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN}}
\DoxyCodeLine{20 \textcolor{comment}{THE SOFTWARE.}}
\DoxyCodeLine{21 \textcolor{comment}{*/}}
\DoxyCodeLine{22 }
\DoxyCodeLine{23 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{24 \textcolor{preprocessor}{\#include "{}hip\_test\_context.hh"{}}}
\DoxyCodeLine{25 \textcolor{preprocessor}{\#include <catch.hpp>}}
\DoxyCodeLine{26 }
\DoxyCodeLine{27 \textcolor{preprocessor}{\#define HIP\_PRINT\_STATUS(status) INFO(hipGetErrorName(status) << "{} at line: "{}} << \_\_LINE\_\_);}
\DoxyCodeLine{28 }
\DoxyCodeLine{29 \textcolor{preprocessor}{\#define HIP\_CHECK(error)                                                                           \(\backslash\)}}
\DoxyCodeLine{30 \textcolor{preprocessor}{  \{                                                                                                \(\backslash\)}}
\DoxyCodeLine{31 \textcolor{preprocessor}{    hipError\_t localError = error;                                                                 \(\backslash\)}}
\DoxyCodeLine{32 \textcolor{preprocessor}{    if ((localError != hipSuccess) \&\& (localError != hipErrorPeerAccessAlreadyEnabled)) \{          \(\backslash\)}}
\DoxyCodeLine{33 \textcolor{preprocessor}{      INFO("{}Error: "{}} << hipGetErrorString(localError) << "{} Code: "{} << localError << "{} Str: "{}       \(\backslash\)}
\DoxyCodeLine{34                      << \#error << "{} In File: "{} << \_\_FILE\_\_ << "{} At line: "{} << \_\_LINE\_\_);           \(\backslash\)}
\DoxyCodeLine{35       REQUIRE(false);                                                                              \(\backslash\)}
\DoxyCodeLine{36     \}                                                                                              \(\backslash\)}
\DoxyCodeLine{37   \}}
\DoxyCodeLine{38 }
\DoxyCodeLine{39 \textcolor{preprocessor}{\#define HIPRTC\_CHECK(error)                                                                        \(\backslash\)}}
\DoxyCodeLine{40 \textcolor{preprocessor}{  \{                                                                                                \(\backslash\)}}
\DoxyCodeLine{41 \textcolor{preprocessor}{    auto localError = error;                                                                       \(\backslash\)}}
\DoxyCodeLine{42 \textcolor{preprocessor}{    if (localError != HIPRTC\_SUCCESS) \{                                                            \(\backslash\)}}
\DoxyCodeLine{43 \textcolor{preprocessor}{      INFO("{}Error: "{}} << hiprtcGetErrorString(localError) << "{} Code: "{} << localError << "{} Str: "{}    \(\backslash\)}
\DoxyCodeLine{44                      << \#error << "{} In File: "{} << \_\_FILE\_\_ << "{} At line: "{} << \_\_LINE\_\_);           \(\backslash\)}
\DoxyCodeLine{45       REQUIRE(false);                                                                              \(\backslash\)}
\DoxyCodeLine{46     \}                                                                                              \(\backslash\)}
\DoxyCodeLine{47   \}}
\DoxyCodeLine{48 \textcolor{comment}{// Although its assert, it will be evaluated at runtime}}
\DoxyCodeLine{49 \textcolor{preprocessor}{\#define HIP\_ASSERT(x)                                                                              \(\backslash\)}}
\DoxyCodeLine{50 \textcolor{preprocessor}{  \{ REQUIRE((x)); \}}}
\DoxyCodeLine{51 }
\DoxyCodeLine{52 \textcolor{preprocessor}{\#ifdef \_\_cplusplus}}
\DoxyCodeLine{53 \textcolor{preprocessor}{  \#include <iostream>}}
\DoxyCodeLine{54 \textcolor{preprocessor}{  \#include <iomanip>}}
\DoxyCodeLine{55 \textcolor{preprocessor}{  \#include <chrono>}}
\DoxyCodeLine{56 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{57 }
\DoxyCodeLine{58 \textcolor{preprocessor}{\#define HIPCHECK(error)                                                                            \(\backslash\)}}
\DoxyCodeLine{59 \textcolor{preprocessor}{    \{                                                                                              \(\backslash\)}}
\DoxyCodeLine{60 \textcolor{preprocessor}{        hipError\_t localError = error;                                                             \(\backslash\)}}
\DoxyCodeLine{61 \textcolor{preprocessor}{        if ((localError != hipSuccess) \&\& (localError != hipErrorPeerAccessAlreadyEnabled)) \{      \(\backslash\)}}
\DoxyCodeLine{62 \textcolor{preprocessor}{            printf("{}error: '\%s'(\%d) from \%s at \%s:\%d\(\backslash\)n"{}}, hipGetErrorString(localError),            \(\backslash\)}
\DoxyCodeLine{63                    localError, \#error, \_\_FILE\_\_, \_\_LINE\_\_);                                        \(\backslash\)}
\DoxyCodeLine{64             abort();                                                                               \(\backslash\)}
\DoxyCodeLine{65         \}                                                                                          \(\backslash\)}
\DoxyCodeLine{66     \}}
\DoxyCodeLine{67 }
\DoxyCodeLine{68 \textcolor{preprocessor}{\#define HIPASSERT(condition)                                                                       \(\backslash\)}}
\DoxyCodeLine{69 \textcolor{preprocessor}{    if (!(condition)) \{                                                                            \(\backslash\)}}
\DoxyCodeLine{70 \textcolor{preprocessor}{        printf("{}assertion \%s at \%s:\%d \(\backslash\)n"{}}, \#condition, \_\_FILE\_\_, \_\_LINE\_\_);                        \(\backslash\)}
\DoxyCodeLine{71         abort();                                                                                   \(\backslash\)}
\DoxyCodeLine{72     \}}
\DoxyCodeLine{73 }
\DoxyCodeLine{74 }
\DoxyCodeLine{75 }
\DoxyCodeLine{76 \textcolor{comment}{// Utility Functions}}
\DoxyCodeLine{77 \textcolor{keyword}{namespace }HipTest \{}
\DoxyCodeLine{78 \textcolor{keyword}{static} \textcolor{keyword}{inline} \textcolor{keywordtype}{int} getDeviceCount() \{}
\DoxyCodeLine{79   \textcolor{keywordtype}{int} dev = 0;}
\DoxyCodeLine{80   HIP\_CHECK(hipGetDeviceCount(\&dev));}
\DoxyCodeLine{81   \textcolor{keywordflow}{return} dev;}
\DoxyCodeLine{82 \}}
\DoxyCodeLine{83 }
\DoxyCodeLine{84 \textcolor{comment}{// Returns the current system time in microseconds}}
\DoxyCodeLine{85 \textcolor{keyword}{static} \textcolor{keyword}{inline} \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} get\_time() \{}
\DoxyCodeLine{86   \textcolor{keywordflow}{return} std::chrono::high\_resolution\_clock::now().time\_since\_epoch()}
\DoxyCodeLine{87       /std::chrono::microseconds(1);}
\DoxyCodeLine{88 \}}
\DoxyCodeLine{89 }
\DoxyCodeLine{90 \textcolor{keyword}{static} \textcolor{keyword}{inline} \textcolor{keywordtype}{double} elapsed\_time(\textcolor{keywordtype}{long} \textcolor{keywordtype}{long} startTimeUs, \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} stopTimeUs) \{}
\DoxyCodeLine{91   \textcolor{keywordflow}{return} ((\textcolor{keywordtype}{double})(stopTimeUs -\/ startTimeUs)) / ((double)(1000));}
\DoxyCodeLine{92 \}}
\DoxyCodeLine{93 }
\DoxyCodeLine{94 \textcolor{keyword}{static} \textcolor{keyword}{inline} \textcolor{keywordtype}{unsigned} setNumBlocks(\textcolor{keywordtype}{unsigned} blocksPerCU, \textcolor{keywordtype}{unsigned} threadsPerBlock, \textcolor{keywordtype}{size\_t} N) \{}
\DoxyCodeLine{95   \textcolor{keywordtype}{int} device;}
\DoxyCodeLine{96   HIP\_CHECK(hipGetDevice(\&device));}
\DoxyCodeLine{97   \mbox{\hyperlink{structhip_device_prop__t}{hipDeviceProp\_t}} props;}
\DoxyCodeLine{98   HIP\_CHECK(hipGetDeviceProperties(\&props, device));}
\DoxyCodeLine{99 }
\DoxyCodeLine{100   \textcolor{keywordtype}{unsigned} blocks = props.\mbox{\hyperlink{structhip_device_prop__t_add8d9d2ad52aece9fd1dbe25c18d9d57}{multiProcessorCount}} * blocksPerCU;}
\DoxyCodeLine{101   \textcolor{keywordflow}{if} (blocks * threadsPerBlock > N) \{}
\DoxyCodeLine{102     blocks = (N + threadsPerBlock -\/ 1) / threadsPerBlock;}
\DoxyCodeLine{103   \}}
\DoxyCodeLine{104 }
\DoxyCodeLine{105   \textcolor{keywordflow}{return} blocks;}
\DoxyCodeLine{106 \}}
\DoxyCodeLine{107 \}}

\end{DoxyCode}
