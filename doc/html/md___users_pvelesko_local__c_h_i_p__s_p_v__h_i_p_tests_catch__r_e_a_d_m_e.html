<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CHIP-SPV: HIP Tests - with Catch2</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CHIP-SPV<span id="projectnumber">&#160;0.1.0</span>
   </div>
   <div id="projectbrief">Multiple backend interface for HIP</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">HIP Tests - with Catch2 </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md958"></a>
Intro and Motivation</h1>
<p >HIP Tests were using HIT framework (a custom framework tailored for HIP) to add, build and run tests. As time progressed the frame got big and took substantial amount of effort to maintain and extend. It also took substantial amount of time to configure. We took this oppurtunity to rewrite the HIP's testing framework and porting the test infra to Catch2 format.</p>
<h1><a class="anchor" id="autotoc_md959"></a>
How to write tests</h1>
<p >Tests in Catch2 are declared via <code>TEST_CASE</code>.</p>
<p ><a href="https://github.com/catchorg/Catch2/blob/v2.13.6/docs/tutorial.md#top">Please read the Catch2 documentation on how to write test cases</a></p>
<p ><a href="https://github.com/catchorg/Catch2/blob/v2.13.6/docs/Readme.md#top">Catch2 Detailed Reference</a></p>
<h1><a class="anchor" id="autotoc_md960"></a>
Taking care of existing features</h1>
<ul>
<li>Don’t build on platform: EXCLUDE_(HIP_PLATFORM/HIP_RUNTIME), can be done via CMAKE. Adding source in if(HIP_PLATFORM == amd/nvidia).</li>
<li>HIPCC_OPTIONS/CLANG Options: Can be done via: set_source_files_properties(src.cc PROPERTIES COMPILE_FLAGS “…”).</li>
<li>Additional libraries: Can be done via target_link_libraries()</li>
<li>Multiple runs with different args: This can be done by Catch’s Feature: GENERATE(…) Running Subtest: ctest –R “...” (Regex to match the subtest name)</li>
</ul>
<h1><a class="anchor" id="autotoc_md961"></a>
New Features</h1>
<ul>
<li>Skip test without recompiling tests, by addition of a json file. Default name is <code>config.json</code> , this can be overridden by using the variable <code>HT_CONFIG_FILE=some_config.json</code>.</li>
<li>Json file supports regex. Ex: All tests which has the word ‘Memset’ can be skipped using ‘*Memset*’</li>
<li>Support multiple skip test list which can be set via environment variable, so you can have multiple files containing different skip test lists and can pick and choose among them depending on your platform and os.</li>
<li>Better CI integration via xunit compatible output</li>
</ul>
<h1><a class="anchor" id="autotoc_md962"></a>
Testing Context</h1>
<p >HIP testing framework gives you a context for each test. This context will have useful information about the environment your test is running.</p>
<p >Some useful functions are:</p><ul>
<li><code>bool isWindows()</code> : true if os is windows</li>
<li><code>bool isLinux()</code> : true if os is linux</li>
<li><code>bool isAmd()</code> : true if platform is AMD</li>
<li><code>bool isNvidia()</code> : true if platform is NVIDIA</li>
</ul>
<p >This information can be accessed in any test via using: <code>TestContext::get().isAmd()</code>.</p>
<h1><a class="anchor" id="autotoc_md963"></a>
Config file schema</h1>
<p >Some tests can be skipped using a config file placed in same directory as the exe.</p>
<p >The schema of the json file is as follows: </p><div class="fragment"><div class="line">{</div>
<div class="line">    &quot;DisabledTests&quot;:</div>
<div class="line">    [</div>
<div class="line">        &quot;TestName1&quot;,</div>
<div class="line">        &quot;TestName2&quot;,</div>
<div class="line">        ...</div>
<div class="line">    ]</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md964"></a>
Env Variables</h1>
<ul>
<li><code>HT_CONFIG_FILE</code> : This variable can be set to the config file name or full path. Disabled tests will be read from this.</li>
<li><code>HT_LOG_ENABLE</code> : This is for debugging the HIP Test Framework itself. Setting it to 1, all <code>LogPrintf</code> will be printed on screen</li>
</ul>
<h1><a class="anchor" id="autotoc_md965"></a>
Enabling New Tests</h1>
<p >Initially, the new tests can be enabled via using <code>-DHIP_CATCH_TEST=ON</code>. After porting existing tests, this will be turned on by default.</p>
<h1><a class="anchor" id="autotoc_md966"></a>
Building a single test</h1>
<div class="fragment"><div class="line">hipcc &lt;path_to_test.cpp&gt; -I&lt;HIP_SRC_DIR&gt;/tests/newTests/include &lt;HIP_SRC_DIR&gt;/tests/newTests/hipTestMain/standalone_main.cc -I&lt;HIP_SRC_DIR&gt;/tests/newTests/external/Catch2 -g -o &lt;out_file_name&gt;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md967"></a>
Debugging support</h1>
<p >Catch2 allows multiple ways in which you can debug the test case.</p><ul>
<li><code>-b</code> options breaks into a debugger as soon as there is a failure encountered <a href="https://github.com/catchorg/Catch2/blob/devel/docs/command-line.md#breaking-into-the-debugger">Catch2 Options Reference</a></li>
<li>Catch2 provided <a href="https://github.com/catchorg/Catch2/blob/v2.13.6/docs/logging.md#top">logging macro</a> that print useful information on test case failure</li>
<li>User can also call <a href="https://github.com/catchorg/Catch2/blob/devel/docs/configuration.md#overriding-catchs-debug-break--b">CATCH_BREAK_INTO_DEBUGGER</a> macro to break at a certain point in a test case.</li>
<li>User can also mention filename.cc:<b>LineNumber</b> to break into a test case via gdb.</li>
</ul>
<h1><a class="anchor" id="autotoc_md968"></a>
External Libs being used</h1>
<ul>
<li><a href="https://github.com/catchorg/Catch2">Catch2</a> - Testing framework</li>
<li><a href="https://github.com/kazuho/picojson">picojson</a> - For config file parsing</li>
</ul>
<h1><a class="anchor" id="autotoc_md969"></a>
Testing Guidelines</h1>
<p >Tests fall in 5 categories and its file name prefix are as follows:</p><ul>
<li>Unit tests (Prefix: Unit_*API*_*Optional Scenario*, example : Unit_hipMalloc_Negative or Unit_hipMalloc): Unit Tests are simplest test for an API, the target here is to test the API with different types of input and different ways of calling.</li>
<li>Application Behavior Modelling tests (Prefix: ABM_*Intent*_*Optional Scenario*, example: ABM_ModuleLoadAndRun): ABM tests are used to model a specific use case of HIP APIs, either seen in a customer app or a general purpose app. It mimics the calling behavior seen in aforementioned app.</li>
<li>Stress/Scale tests (Prefix: Stress_*API*_*Intent*_*Optional Scenario*, example: Stress_hipMemset_ExhaustVRAM): These tests are used to see the behavior of HIP APIs in edge scenarios, for example what happens when we have exhausted vram and do a hipMalloc or run many instances of same API in parallel.</li>
<li>Multi Process tests (Prefix: MultiProc_*API*_*Optional Scenario*, example: MultiProc_hipIPCMemHandle_GetDataFromProc): These tests are multi process tests and will only run on linux. They are used to test HIP APIs in multi process environment</li>
<li>Performance tests(Prefix: Perf_*Intent*_*Optional Scenario*, example: Perf_DispatchLatenc  y): Performance tests are used to get results of HIP APIs.</li>
</ul>
<p >There is a special interface available for process isolation. <code><a class="el" href="clasship_1_1_spawn_proc.html">hip::SpawnProc</a></code> in <code><a class="el" href="hip__test__process_8hh_source.html">hip_test_process.hh</a></code>. Using this interface test can spawn of process and place passing conditions on its return value or its output to stdout. This can be useful for testing printf tests. Sample Usage: </p><div class="fragment"><div class="line"><a class="code hl_class" href="clasship_1_1_spawn_proc.html">hip::SpawnProc</a> proc(&lt;relative path of exe with test folder&gt;, &lt;optional <span class="keywordtype">bool</span> value, <span class="keywordflow">if</span> output is to be recorded&gt;);</div>
<div class="line">REQUIRE(0 == proc.run()); <span class="comment">// Test of return value of the proc</span></div>
<div class="line">REQUIRE(exepctedOutput == proc.getOutput()); <span class="comment">// Test on expected output of the process</span></div>
<div class="ttc" id="aclasship_1_1_spawn_proc_html"><div class="ttname"><a href="clasship_1_1_spawn_proc.html">hip::SpawnProc</a></div><div class="ttdef"><b>Definition:</b> hip_test_process.hh:44</div></div>
</div><!-- fragment --><p> The process can be a standalone exe (see tests/catch/unit/printfExe for more information).</p>
<p >General Guidelines:</p><ul>
<li>Do not use the catch2 tags. Tags wont be used for filtering</li>
<li>Add as many INFO() as you can in tests which prints state of the t est, this will help the debugger when the test fails (INFO macro only prints when the test fails)</li>
<li>Check return of each HIP API and fail whenever there is a misma tch with hipSuccess or hiprtcSuccess.</li>
<li>Each Category of test will hav e its own exe and catch_discover_test macro will be called on it to discover its tests</li>
<li>Optional Scenario in test names are optional. For example you can test all Scenarios of hipMalloc API in one file, you can name the file Unit_hipMalloc, if you are having a file just for negative scenarios you can name it as Unit_hipMalloc_Negative. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
