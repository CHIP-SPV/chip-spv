<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CHIP-SPV: Emitting Static Library</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CHIP-SPV<span id="projectnumber">&#160;0.1.0</span>
   </div>
   <div id="projectbrief">Multiple backend interface for HIP</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Emitting Static Library </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >This sample shows how to generate a static library for a simple HIP application. We will evaluate two types of static libraries: the first type exports host functions in a static library generated with &ndash;emit-static-lib and is compatible with host linkers, and second type exports device functions in a static library made with system ar.</p>
<p >Please refer to the hip_programming_guide for limitations.</p>
<h1><a class="anchor" id="autotoc_md875"></a>
Static libraries with host functions</h1>
<h2><a class="anchor" id="autotoc_md876"></a>
Source files</h2>
<p >The static library source files may contain host functions and kernel <code>__global__</code> and <code>__device__</code> functions. Here is an example (please refer to the directory host_functions).</p>
<p >hipOptLibrary.cpp: </p><div class="fragment"><div class="line">#define HIP_ASSERT(status) assert(status == hipSuccess)</div>
<div class="line">#define LEN 512</div>
<div class="line"> </div>
<div class="line">__global__ void copy(uint32_t* A, uint32_t* B) {</div>
<div class="line">    size_t tid = threadIdx.x + blockIdx.x * blockDim.x;</div>
<div class="line">    B[tid] = A[tid];</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void run_test1() {</div>
<div class="line">    uint32_t *A_h, *B_h, *A_d, *B_d;</div>
<div class="line">    size_t valbytes = LEN * sizeof(uint32_t);</div>
<div class="line"> </div>
<div class="line">    A_h = (uint32_t*)malloc(valbytes);</div>
<div class="line">    B_h = (uint32_t*)malloc(valbytes);</div>
<div class="line">    for (uint32_t i = 0; i &lt; LEN; i++) {</div>
<div class="line">        A_h[i] = i;</div>
<div class="line">        B_h[i] = 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    HIP_ASSERT(hipMalloc((void**)&amp;A_d, valbytes));</div>
<div class="line">    HIP_ASSERT(hipMalloc((void**)&amp;B_d, valbytes));</div>
<div class="line"> </div>
<div class="line">    HIP_ASSERT(hipMemcpy(A_d, A_h, valbytes, hipMemcpyHostToDevice));</div>
<div class="line">    hipLaunchKernelGGL(copy, dim3(LEN/64), dim3(64), 0, 0, A_d, B_d);</div>
<div class="line">    HIP_ASSERT(hipMemcpy(B_h, B_d, valbytes, hipMemcpyDeviceToHost));</div>
<div class="line"> </div>
<div class="line">    for (uint32_t i = 0; i &lt; LEN; i++) {</div>
<div class="line">        assert(A_h[i] == B_h[i]);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    HIP_ASSERT(hipFree(A_d));</div>
<div class="line">    HIP_ASSERT(hipFree(B_d));</div>
<div class="line">    free(A_h);</div>
<div class="line">    free(B_h);</div>
<div class="line">    std::cout &lt;&lt; &quot;Test Passed!\n&quot;;</div>
<div class="line">}</div>
</div><!-- fragment --><p >The above source file can be compiled into a static library, libHipOptLibrary.a, using the &ndash;emit-static-lib flag, like so: </p><div class="fragment"><div class="line">hipcc hipOptLibrary.cpp --emit-static-lib -fPIC -o libHipOptLibrary.a</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md877"></a>
Main source files</h2>
<p >The main() program source file may link with the above static library using either hipcc or a host compiler (such as g++). <a class="el" href="class_a.html">A</a> simple source file that calls the host function inside libHipOptLibrary.a:</p>
<p >hipMain1.cpp: </p><div class="fragment"><div class="line">extern void run_test1();</div>
<div class="line"> </div>
<div class="line">int main(){</div>
<div class="line">  run_test1();</div>
<div class="line">}</div>
</div><!-- fragment --><p >To link to the static library:</p>
<p >Using hipcc: </p><div class="fragment"><div class="line">hipcc hipMain1.cpp -L. -lHipOptLibrary -o test_emit_static_hipcc_linker.out</div>
</div><!-- fragment --><p> Using g++: </p><div class="fragment"><div class="line">g++ hipMain1.cpp -L. -lHipOptLibrary -L/opt/rocm/hip/lib -lamdhip64 -o test_emit_static_host_linker.out</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md878"></a>
Static libraries with device functions</h1>
<h2><a class="anchor" id="autotoc_md879"></a>
Source files</h2>
<p >The static library source files which contain only <code>__device__</code> functions need to be created using ar. Here is an example (please refer to the directory device_functions).</p>
<p >hipDevice.cpp: </p><div class="fragment"><div class="line">#include &lt;hip/hip_runtime.h&gt;</div>
<div class="line"> </div>
<div class="line">__device__ int square_me(int A) {</div>
<div class="line">  return A*A;</div>
<div class="line">}</div>
</div><!-- fragment --><p >The above source file may be compiled into a static library, libHipDevice.a, by first compiling into a relocatable object, and then placed in an archive using ar: </p><div class="fragment"><div class="line">hipcc hipDevice.cpp -c -fgpu-rdc -fPIC -o hipDevice.o</div>
<div class="line">ar rcsD libHipDevice.a hipDevice.o</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md880"></a>
Main source files</h2>
<p >The main() program source file can link with the static library using hipcc. <a class="el" href="class_a.html">A</a> simple source file that calls the device function inside libHipDevice.a:</p>
<p >hipMain2.cpp: </p><div class="fragment"><div class="line">#include &lt;hip/hip_runtime.h&gt;</div>
<div class="line">#include &lt;hip/hip_runtime_api.h&gt;</div>
<div class="line">#include &lt;iostream&gt;</div>
<div class="line"> </div>
<div class="line">#define HIP_ASSERT(status) assert(status == hipSuccess)</div>
<div class="line">#define LEN 512</div>
<div class="line"> </div>
<div class="line">extern __device__ int square_me(int);</div>
<div class="line"> </div>
<div class="line">__global__ void square_and_save(int* A, int* B) {</div>
<div class="line">    int tid = threadIdx.x + blockIdx.x * blockDim.x;</div>
<div class="line">    B[tid] = square_me(A[tid]);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void run_test2() {</div>
<div class="line">    int *A_h, *B_h, *A_d, *B_d;</div>
<div class="line">    A_h = new int[LEN];</div>
<div class="line">    B_h = new int[LEN];</div>
<div class="line">    for (unsigned i = 0; i &lt; LEN; i++) {</div>
<div class="line">        A_h[i] = i;</div>
<div class="line">        B_h[i] = 0;</div>
<div class="line">    }</div>
<div class="line">    size_t valbytes = LEN*sizeof(int);</div>
<div class="line"> </div>
<div class="line">    HIP_ASSERT(hipMalloc((void**)&amp;A_d, valbytes));</div>
<div class="line">    HIP_ASSERT(hipMalloc((void**)&amp;B_d, valbytes));</div>
<div class="line"> </div>
<div class="line">    HIP_ASSERT(hipMemcpy(A_d, A_h, valbytes, hipMemcpyHostToDevice));</div>
<div class="line">    hipLaunchKernelGGL(square_and_save, dim3(LEN/64), dim3(64),</div>
<div class="line">                       0, 0, A_d, B_d);</div>
<div class="line">    HIP_ASSERT(hipMemcpy(B_h, B_d, valbytes, hipMemcpyDeviceToHost));</div>
<div class="line"> </div>
<div class="line">    for (unsigned i = 0; i &lt; LEN; i++) {</div>
<div class="line">        assert(A_h[i]*A_h[i] == B_h[i]);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    HIP_ASSERT(hipFree(A_d));</div>
<div class="line">    HIP_ASSERT(hipFree(B_d));</div>
<div class="line">    free(A_h);</div>
<div class="line">    free(B_h);</div>
<div class="line">    std::cout &lt;&lt; &quot;Test Passed!\n&quot;;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">int main(){</div>
<div class="line">  // Run test that generates static lib with ar</div>
<div class="line">  run_test2();</div>
<div class="line">}</div>
</div><!-- fragment --><p >To link to the static library: </p><div class="fragment"><div class="line">hipcc libHipDevice.a hipMain2.cpp -fgpu-rdc -o test_device_static_hipcc.out</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md881"></a>
How to build and run this sample:</h1>
<p >Use the make command to build the static libraries, link with it, and execute it.</p><ul>
<li>Change directory to either host or device functions folder.</li>
<li>To build the static library and link the main executable, use <code>make all</code>.</li>
<li>To execute, run the generated executable <code>./test_*.out</code>.</li>
</ul>
<p >Alternatively, use these CMake commands. </p><div class="fragment"><div class="line">cd device_functions</div>
<div class="line">mkdir -p build</div>
<div class="line">cd build</div>
<div class="line">cmake ..</div>
<div class="line">make</div>
<div class="line">./test_*.out</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md882"></a>
For More Infomation, please refer to the HIP FAQ.</h1>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
