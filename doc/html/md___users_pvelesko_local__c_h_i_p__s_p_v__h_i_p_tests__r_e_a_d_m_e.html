<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CHIP-SPV: HIP testing environment.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CHIP-SPV<span id="projectnumber">&#160;0.1.0</span>
   </div>
   <div id="projectbrief">Multiple backend interface for HIP</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">HIP testing environment. </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >This document explains how to use the HIP CMAKE testing environment. We make use of the HIT Integrated Tester (HIT) framework to automatically find and add test cases to the CMAKE testing environment.</p>
<h2><a class="anchor" id="autotoc_md971"></a>
Quickstart</h2>
<p >HIP unit tests are integrated into the top-level cmake project. The tests depend upon the installed version of HIP. Typical usage (paths relative to top of the HIP repo): </p><div class="fragment"><div class="line">$ mkdir build</div>
<div class="line">$ cd build</div>
<div class="line">$ cmake .. -DCMAKE_INSTALL_PREFIX=$PWD/install</div>
<div class="line">$ make</div>
<div class="line">$ make install</div>
<div class="line">$ make build_tests</div>
<div class="line">$ make test</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md972"></a>
How to add a new test</h2>
<p >The test infrastructure use a hierarchy of folders. So add the new test to the appropriate folder. The tests/src/runtimeApi/memory/hipMemset.cpp file contains a simple unit test and is a good starting point for other tests. Copy this to a new test name and modify it.</p>
<h2><a class="anchor" id="autotoc_md973"></a>
HIP Integrated Tester (HIT)</h2>
<p >The HIT framework automatically finds and adds test cases to the CMAKE testing environment. It achives this by parsing all files in the tests/src folder. The parser looks for a code block similar to the one below. </p><div class="fragment"><div class="line">/* HIT_START</div>
<div class="line"> * BUILD: %t %s ../../test_common.cpp</div>
<div class="line"> * TEST: %t</div>
<div class="line"> * //Small copy</div>
<div class="line"> * TEST: %t -N 10    --memsetval 0x42</div>
<div class="line"> * // Oddball size</div>
<div class="line"> * TEST: %t -N 10013 --memsetval 0x5a</div>
<div class="line"> * // Big copy</div>
<div class="line"> * TEST: %t -N 256M  --memsetval 0xa6</div>
<div class="line"> * HIT_END</div>
<div class="line"> */</div>
</div><!-- fragment --><p> In the above, BUILD commands provide instructions on how to build the test case while TEST commands provide instructions on how to execute the test case.</p>
<h3><a class="anchor" id="autotoc_md974"></a>
BUILD command</h3>
<p >The supported syntax for the BUILD command is: </p><div class="fragment"><div class="line">BUILD: %t %s HIPCC_OPTIONS &lt;hipcc_specific_options&gt; CLANG_OPTIONS &lt;clang_specific_options&gt; NVCC_OPTIONS &lt;nvcc_specific_options&gt; EXCLUDE_HIP_PLATFORM &lt;amd|nvidia|all&gt; EXCLUDE_HIP_RUNTIME &lt;rocclr&gt; EXCLUDE_HIP_COMPILER &lt;clang&gt; DEPENDS EXCLUDE_HIP_LIB_TYPE &lt;static|shared&gt; &lt;dependencies&gt;</div>
</div><!-- fragment --><p> s: refers to current source file name. Additional source files needed for the test can be specified by name (including relative path). t: refers to target executable named derived by removing the extension from the current source file. Alternatively a target executable name can be specified. HIPCC_OPTIONS: All options specified after this delimiter are passed to hipcc on both amd and nvidia platforms. CLANG_OPTIONS: All options specified after this delimiter are passed to hipcc on HIP-Clang compiler only. NVCC_OPTIONS: All options specified after this delimiter are passed to hipcc on nvidia platform only. EXCLUDE_HIP_PLATFORM: This can be used to exclude a test case from amd, nvidia or both platforms. EXCLUDE_HIP_RUNTIME: This can be used to exclude a test case from rocclr runtime. EXCLUDE_HIP_COMPILER: This can be used to exclude a test case from clang compiler. EXCLUDE_HIP_RUNTIME AND EXCLUDE_HIP_COMPILER: when both options are specified it excludes test case from particular runtime and compiler. EXCLUDE_HIP_LIB_TYPE: This can be used to exclude a test case from static or shared libs. DEPENDS: This can be used to specify dependencies that need to be built before building the current target.</p>
<h3><a class="anchor" id="autotoc_md975"></a>
BUILD_CMD command</h3>
<p >The supported syntax for the BUILD_CMD command is: </p><div class="fragment"><div class="line">BUILD_CMD: &lt;targetname&gt; &lt;build_command&gt; EXCLUDE_HIP_PLATFORM &lt;amd|nvidia|all&gt; EXCLUDE_HIP_RUNTIME &lt;rocclr&gt; EXCLUDE_HIP_COMPILER &lt;clang&gt; EXCLUDE_HIP_LIB_TYPE &lt;static|shared&gt; DEPENDS &lt;dependencies&gt;</div>
</div><!-- fragment --><p> s: refers to current source file name. Additional source files needed for the test can be specified by name (including relative path). t: refers to target executable named derived by removing the extension from the current source file. Alternatively a target executable name can be specified. hc: refers to hipcc pointed to by $CMAKE_INSTALL_PREFIX/bin/hipcc. hip-path: refers to hip installed location pointed to by $CMAKE_INSTALL_PREFIX cc: refers to system c compiler pointed to by /usr/bin/cc. cxx: refers to system c compiler pointed to by /usr/bin/c++. S: refers to path to current source file. T: refers to path to current build target. EXCLUDE_HIP_PLATFORM: This can be used to exclude a test case from amd, nvidia or both platforms. EXCLUDE_HIP_RUNTIME: This can be used to exclude a test case from rocclr runtime. EXCLUDE_HIP_COMPILER: This can be used to exclude a test case from clang compiler. EXCLUDE_HIP_RUNTIME AND EXCLUDE_HIP_COMPILER: when both options are specified it excludes test from particular runtime and compiler. EXCLUDE_HIP_LIB_TYPE: This can be used to exclude a test case from static or shared libs. DEPENDS: This can be used to specify dependencies that need to be built before building the current target.</p>
<h3><a class="anchor" id="autotoc_md976"></a>
TEST command</h3>
<p >The supported syntax for the TEST command is: </p><div class="fragment"><div class="line">TEST: %t &lt;arguments_to_test_executable&gt; EXCLUDE_HIP_PLATFORM &lt;amd|nvidia|all&gt; EXCLUDE_HIP_RUNTIME &lt;rocclr&gt; EXCLUDE_HIP_COMPILER &lt;clang&gt; EXCLUDE_HIP_LIB_TYPE &lt;static|shared&gt;</div>
</div><!-- fragment --><p> t: refers to target executable named derived by removing the extension from the current source file. Alternatively a target executable name can be specified. EXCLUDE_HIP_PLATFORM: This can be used to exclude a test case from amd, nvidia or both platforms. EXCLUDE_HIP_RUNTIME: This can be used to exclude a test case from rocclr runtime. EXCLUDE_HIP_COMPILER: This can be used to exclude a test case from clang compiler. EXCLUDE_HIP_RUNTIME AND EXCLUDE_HIP_COMPILER: when both options are specified it excludes test from particular runtime and compiler. EXCLUDE_HIP_LIB_TYPE: This can be used to exclude a test case from static or shared libs.</p>
<p >Note that if the test has been excluded for a specific platform/runtime/compiler in the BUILD command, it is automatically excluded from the TEST command as well for the sameplatform.</p>
<h3><a class="anchor" id="autotoc_md977"></a>
TEST_NAMED command</h3>
<p >When using the TEST command, HIT will squash and append the arguments specified to the test executable name to generate the CMAKE test name. Sometimes we might want to specify a more descriptive name. The TEST_NAMED command is used for that. The supported syntax for the TEST_NAMED command is: </p><div class="fragment"><div class="line">TEST: %t CMAKE_TEST_NAME &lt;arguments_to_test_executable&gt; EXCLUDE_HIP_PLATFORM &lt;amd|nvidia|all&gt; EXCLUDE_HIP_RUNTIME &lt;rocclr&gt; EXCLUDE_HIP_COMPILER &lt;clang&gt; EXCLUDE_HIP_LIB_TYPE &lt;static|shared&gt;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md978"></a>
Running tests:</h2>
<div class="fragment"><div class="line">ctest</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md979"></a>
Run subsets of all tests:</h2>
<div class="fragment"><div class="line"># Run one test on the commandline</div>
<div class="line">./directed_tests/runtime/memory/hipMemset</div>
<div class="line"> </div>
<div class="line"># Run all the hipMemcpy tests:</div>
<div class="line">ctest -R Memcpy</div>
<div class="line"> </div>
<div class="line"># Run all tests in a specific folder:</div>
<div class="line">ctest -R memory</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md980"></a>
Performance tests:</h2>
<div class="fragment"><div class="line">Above tests are direct tests which are majorly used for function verification.</div>
<div class="line">We also provide performance tests under tests/performance folder.</div>
<div class="line"> </div>
<div class="line"># Build all performance tests after running &quot;make install&quot; under build folder:</div>
<div class="line">make build_perf</div>
<div class="line"> </div>
<div class="line">Then all performance test applications will be built into ./performance_tests folder.</div>
<div class="line"> </div>
<div class="line"># Run all performance tests:</div>
<div class="line">make perf</div>
<div class="line"> </div>
<div class="line"># Run individual performance test:</div>
<div class="line">For example,</div>
<div class="line">performance_tests/memory/hipPerfMemMallocCpyFree</div>
<div class="line"> </div>
<div class="line"># Run a specific test set:</div>
<div class="line">For example,</div>
<div class="line">/usr/bin/ctest -C performance -R performance_tests/perfDispatch --verbose</div>
<div class="line">Here &quot;-C performance&quot; indicate the &quot;performance&quot; configuration of ctest.</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md981"></a>
If a test fails - how to debug a test</h2>
<p >Find the test and commandline that fail:</p>
<p >(From the build directory, perhaps hip/build) grep -IR hipMemcpy-modes -IR ../tests/ ../tests/src/runtimeApi/memory/hipMemcpy.cpp: * TEST_NAMED: t hipMemcpy-modes &ndash;tests 0x1</p>
<h1><a class="anchor" id="autotoc_md982"></a>
Guidelines for adding new tests</h1>
<ul>
<li>Prefer to enhance an existing test as opposed to writing a new one. Tests have overhead to start and many small tests spend precious test time on startup and initialization issues.</li>
<li>Make the test run standalone without requirement for command-line arguments. THis makes it easier to debug since the name of the test is shown in the test report and if you know the name of the test you can the run the test.</li>
<li>For long-running tests or tests with multiple phases, consider using the &ndash;tests option as an optional mechanism to allow debuggers to start with the failing subset of the test. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
