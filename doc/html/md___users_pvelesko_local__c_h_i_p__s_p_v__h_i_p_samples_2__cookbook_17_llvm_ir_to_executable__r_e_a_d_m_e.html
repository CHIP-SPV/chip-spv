<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CHIP-SPV: Compile to LLVM IR and create an executable from modified IR</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CHIP-SPV<span id="projectnumber">&#160;0.1.0</span>
   </div>
   <div id="projectbrief">Multiple backend interface for HIP</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Compile to LLVM IR and create an executable from modified IR </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >This sample shows how to generate the LLVM IR for a simple HIP source application, then re-compiling it and generating a valid HIP executable.</p>
<p >This sample uses a previous HIP application sample, please see <a href="https://github.com/ROCm-Developer-Tools/HIP/blob/master/samples/0_Intro/square">0_Intro/square</a>.</p>
<h1><a class="anchor" id="autotoc_md889"></a>
Compiling the HIP source into LLVM IR</h1>
<p >Using HIP flags <code>-c -emit-llvm</code> will help generate the host x86_64 and the device LLVM bitcode when paired with <code>--cuda-host-only</code> and <code>--cuda-device-only</code> respectively. In this sample we use these commands: </p><div class="fragment"><div class="line">/opt/rocm/hip/bin/hipcc -c -emit-llvm --cuda-host-only -target x86_64-linux-gnu -o square_host.bc square.cpp</div>
<div class="line">/opt/rocm/hip/bin/hipcc -c -emit-llvm --cuda-device-only --offload-arch=gfx900 --offload-arch=gfx906 square.cpp</div>
</div><!-- fragment --><p> The device LLVM IR bitcode will be output into two separate files:</p><ul>
<li>square-hip-amdgcn-amd-amdhsa-gfx900.bc</li>
<li>square-hip-amdgcn-amd-amdhsa-gfx906.bc</li>
</ul>
<p >You may modify <code>--offload-arch</code> flag to build other archs and choose to enable or disable xnack and sram-ecc.</p>
<p >To transform the LLVM bitcode into human readable LLVM IR, use these commands: </p><div class="fragment"><div class="line">/opt/rocm/llvm/bin/llvm-dis square-hip-amdgcn-amd-amdhsa-gfx900.bc -o square-hip-amdgcn-amd-amdhsa-gfx900.ll</div>
<div class="line">/opt/rocm/llvm/bin/llvm-dis square-hip-amdgcn-amd-amdhsa-gfx906.bc -o square-hip-amdgcn-amd-amdhsa-gfx906.ll</div>
</div><!-- fragment --><p ><b>Warning:</b> We cannot ensure any compiler besides the ROCm hipcc and clang will be compatible with this process. Also, there is no guarantee that the starting IR produced with <code>-x cl</code> will run with HIP runtime. Experimenting with other compilers or starting IR will be the responsibility of the developer.</p>
<h1><a class="anchor" id="autotoc_md890"></a>
Modifying the LLVM IR</h1>
<p ><em><b>Warning: The LLVM Language Specification may change across LLVM major releases, therefore the user must make sure the modified LLVM IR conforms to the LLVM Language Specification corresponding to the used LLVM version.</b></em></p>
<p >At this point, you may evaluate the LLVM IR and make modifications if you are familiar with the LLVM IR language. Since the LLVM IR can vary between compiler versions, the safest approach would be to use the same compiler to consume the IR as the compiler producing it. It is the responsibility of the developer to ensure the IR is valid when manually modifying it.</p>
<h1><a class="anchor" id="autotoc_md891"></a>
Compiling the LLVM IR into a valid HIP executable</h1>
<p >If valid, the modified host and device IR may be compiled into a HIP executable. First, the readable IR must be compiled back in LLVM bitcode. The host IR can be compiled into an object using this command: </p><div class="fragment"><div class="line">/opt/rocm/llvm/bin/llvm-as square_host.ll -o square_host.bc</div>
<div class="line">/opt/rocm/hip/bin/hipcc -c square_host.bc -o square_host.o</div>
</div><!-- fragment --><p >However, the device IR will require a few extra steps. The device bitcodes needs to be compiled into device objects, then offload-bundled into a HIP fat binary using the clang-offload-bundler, then llvm-mc embeds the binary inside of a host object using the MC directives provided in <code>hip_obj_gen.mcin</code>. The output is a host object with an embedded device object. Here are the steps for device side compilation into an object: </p><div class="fragment"><div class="line">/opt/rocm/hip/../llvm/bin/llvm-as square-hip-amdgcn-amd-amdhsa-gfx900.ll -o square-hip-amdgcn-amd-amdhsa-gfx900.bc</div>
<div class="line">/opt/rocm/hip/../llvm/bin/llvm-as square-hip-amdgcn-amd-amdhsa-gfx906.ll -o square-hip-amdgcn-amd-amdhsa-gfx906.bc</div>
<div class="line">/opt/rocm/hip/../llvm/bin/clang -target amdgcn-amd-amdhsa -mcpu=gfx900 square-hip-amdgcn-amd-amdhsa-gfx900.bc -o square-hip-amdgcn-amd-amdhsa-gfx900.o</div>
<div class="line">/opt/rocm/hip/../llvm/bin/clang -target amdgcn-amd-amdhsa -mcpu=gfx906 square-hip-amdgcn-amd-amdhsa-gfx906.bc -o square-hip-amdgcn-amd-amdhsa-gfx906.o</div>
<div class="line">/opt/rocm/hip/../llvm/bin/clang-offload-bundler -type=o -bundle-align=4096 -targets=host-x86_64-unknown-linux,hip-amdgcn-amd-amdhsa-gfx900,hip-amdgcn-amd-amdhsa-gfx906 -inputs=/dev/null,square-hip-amdgcn-amd-amdhsa-gfx900.o,square-hip-amdgcn-amd-amdhsa-gfx906.o -outputs=offload_bundle.hipfb</div>
<div class="line">/opt/rocm/llvm/bin/llvm-mc hip_obj_gen.mcin -o square_device.o --filetype=obj</div>
</div><!-- fragment --><p ><b>Note:</b> Using option <code>-bundle-align=4096</code> only works on ROCm 4.0 and newer compilers. Also, the architecture must match the same arch as when compiling to LLVM IR.</p>
<p >Finally, using the system linker, hipcc, or clang, link the host and device objects into an executable: </p><div class="fragment"><div class="line">/opt/rocm/hip/bin/hipcc square_host.o square_device.o -o square_ir.out</div>
</div><!-- fragment --><p> If you haven't modified the GPU archs, this executable should run on both <code>gfx900</code> and <code>gfx906</code>.</p>
<h1><a class="anchor" id="autotoc_md892"></a>
How to build and run this sample:</h1>
<p >Use these make commands to compile into LLVM IR, compile IR into executable, and execute it.</p><ul>
<li>To compile the HIP application into host and device LLVM IR: <code>make src_to_ir</code>.</li>
<li>To disassembly the LLVM IR bitcode into human readable LLVM IR: <code>make bc_to_ll</code>.</li>
<li>To assembly the human readable LLVM IR bitcode back into LLVM IR bitcode: <code>make ll_to_bc</code>.</li>
<li>To compile the LLVM IR files into an executable: <code>make ir_to_exec</code>.</li>
<li>To execute, run <code>./square_ir.out</code>.</li>
</ul>
<p ><b>Note:</b> The default arch is <code>gfx900</code> and <code>gfx906</code>, this can be modified with make argument <code>GPU_ARCH1</code> and <code>GPU_ARCH2</code>.</p>
<h1><a class="anchor" id="autotoc_md893"></a>
For More Information, please refer to the HIP FAQ.</h1>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
